<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanceAI æ™ºæ…§ç†è²¡ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
    <div id="app"></div>

    <script>
        // å…¨åŸŸç‹€æ…‹
        let expenses = [];
        let monthlyIncome = null;
        let activeView = 'menu';
        let chartInstance = null;
        let goal = null;
        let goalAmount = null;
        let investmentType = null;
        let expectedReturn = null;
        let sharedLedger = [];

        // è‡ªå‹•åˆ†é¡åŠŸèƒ½
        function autoCategory(item) {
            const itemLower = item.toLowerCase();
            const mapping = {
                food: ["food", "meal", "drink", "é£²æ–™", "é¤", "åƒ", "ä¾¿ç•¶", "é£Ÿç‰©", "é£Ÿ"],
                transport: ["bus", "train", "uber", "transport", "è»Š", "æ·é‹", "å…¬è»Š", "è¨ˆç¨‹è»Š", "äº¤é€š"],
                entertainment: ["game", "movie", "fun", "å¨›æ¨‚", "é›»å½±", "éŠæˆ²", "éŸ³æ¨‚"],
                study: ["book", "study", "è£œç¿’", "å­¸ç¿’", "æ›¸", "èª²ç¨‹", "æ–‡å…·"]
            };
            
            for (const [category, keywords] of Object.entries(mapping)) {
                if (keywords.some(k => itemLower.includes(k))) {
                    return category;
                }
            }
            return "others";
        }

        // æ ¼å¼åŒ–æ•¸å­—
        function formatNumber(num) {
            if (!num) return 'N/A';
            if (num >= 1e12) return `$${(num / 1e12).toFixed(2)}T`;
            if (num >= 1e9) return `$${(num / 1e9).toFixed(2)}B`;
            if (num >= 1e6) return `$${(num / 1e6).toFixed(2)}M`;
            return `$${num.toFixed(2)}`;
        }

        // ç²å–ä»Šå¤©æ—¥æœŸ
        function getTodayDate() {
            const today = new Date();
            return today.toISOString().split('T')[0];
        }

        // æ¸²æŸ“ä¸»é¸å–®
        function renderMenu() {
            const menuItems = [
                { icon: 'ğŸ’°', label: 'è¨­å®šæ¯æœˆæ”¶å…¥', view: 'income', color: 'bg-emerald-500' },
                { icon: 'â•', label: 'æ–°å¢æ”¯å‡ºç´€éŒ„', view: 'add', color: 'bg-blue-500' },
                { icon: 'ğŸ“Š', label: 'æŸ¥çœ‹æ”¶æ”¯åˆ†æ', view: 'chart', color: 'bg-green-500' },
                { icon: 'ğŸ¯', label: 'è¨­å®šç›®æ¨™ + æŠ•è³‡', view: 'goal', color: 'bg-purple-500' },
                { icon: 'ğŸ’¡', label: 'AI å°ˆæ¥­ç†è²¡å»ºè­°', view: 'advice', color: 'bg-yellow-500' },
                { icon: 'ğŸ‘¥', label: 'å…±äº«å¸³æœ¬çµç®—', view: 'shared', color: 'bg-pink-500' }
            ];

            const menuHTML = `
                <div class="max-w-5xl mx-auto">
                    <div class="text-center mb-8">
                        <h1 class="text-4xl font-bold text-gray-800 mb-2">FinanceAI</h1>
                        <p class="text-gray-600">æ™ºæ…§ç†è²¡ç®¡ç†ç³»çµ±</p>
                    </div>
                    
                    ${monthlyIncome !== null ? `
                        <div class="mb-6 p-4 bg-white rounded-lg shadow text-center">
                            <p class="text-gray-700">
                                ğŸ’µ æ¯æœˆæ”¶å…¥ï¼š<span class="font-bold text-green-600">NT$ ${monthlyIncome.toFixed(0)}</span>
                            </p>
                        </div>
                    ` : ''}
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        ${menuItems.map(item => `
                            <button onclick="changeView('${item.view}')" 
                                class="${item.color} text-white p-6 rounded-lg shadow-lg hover:opacity-90 transition-all transform hover:scale-105">
                                <div class="text-5xl mb-3">${item.icon}</div>
                                <p class="text-xl font-semibold">${item.label}</p>
                            </button>
                        `).join('')}
                    </div>
                    
                    ${expenses.length > 0 ? `
                        <div class="mt-6 p-4 bg-white rounded-lg shadow">
                            <p class="text-center text-gray-700">
                                ğŸ“Š ç›®å‰å…±æœ‰ <span class="font-bold">${expenses.length}</span> ç­†æ”¯å‡ºç´€éŒ„
                            </p>
                        </div>
                    ` : ''}
                </div>
            `;
            document.getElementById('app').innerHTML = menuHTML;
        }

        // æ¸²æŸ“è¨­å®šæ”¶å…¥é é¢
        function renderIncome() {
            const html = `
                <div class="bg-white rounded-lg shadow-lg p-6 max-w-md mx-auto">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">ğŸ’° è¨­å®šæ¯æœˆæ”¶å…¥</h2>
                    <form id="incomeForm">
                        <input type="number" id="incomeAmount" placeholder="è«‹è¼¸å…¥æ¯æœˆæ”¶å…¥" required
                            value="${monthlyIncome || ''}"
                            class="w-full p-3 border rounded mb-3" step="0.01">
                        
                        <button type="submit" 
                            class="w-full bg-emerald-500 text-white p-3 rounded hover:bg-emerald-600 mb-2">
                            ç¢ºèªè¨­å®š
                        </button>
                        <button type="button" onclick="changeView('menu')"
                            class="w-full bg-gray-300 text-gray-700 p-3 rounded hover:bg-gray-400">
                            è¿”å›
                        </button>
                    </form>
                </div>
            `;
            document.getElementById('app').innerHTML = html;

            document.getElementById('incomeForm').addEventListener('submit', function(e) {
                e.preventDefault();
                monthlyIncome = parseFloat(document.getElementById('incomeAmount').value);
                alert('âœ… æ¯æœˆæ”¶å…¥å·²è¨­å®šå®Œæˆ');
                changeView('menu');
            });
        }

        // æ¸²æŸ“æ–°å¢æ”¯å‡ºé é¢
        function renderAddExpense() {
            const html = `
                <div class="bg-white rounded-lg shadow-lg p-6 max-w-md mx-auto">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">æ–°å¢æ”¯å‡ºç´€éŒ„</h2>
                    <form id="expenseForm">
                        <input type="date" id="expenseDate" required
                            value="${getTodayDate()}"
                            class="w-full p-3 border rounded mb-3">
                        
                        <input type="text" id="item" placeholder="æ”¯å‡ºé …ç›®åç¨±" required
                            class="w-full p-3 border rounded mb-3">
                        
                        <input type="number" id="amount" placeholder="é‡‘é¡" required
                            class="w-full p-3 border rounded mb-3" step="0.01">
                        
                        <div class="mb-4">
                            <label class="flex items-center mb-2">
                                <input type="checkbox" id="autoMode" checked class="mr-2">
                                <span>è‡ªå‹•åˆ†é¡</span>
                            </label>
                            
                            <select id="category" class="w-full p-3 border rounded" style="display: none;">
                                <option value="">é¸æ“‡åˆ†é¡</option>
                                <option value="food">Food (é£Ÿç‰©)</option>
                                <option value="transport">Transport (äº¤é€š)</option>
                                <option value="entertainment">Entertainment (å¨›æ¨‚)</option>
                                <option value="study">Study (å­¸ç¿’)</option>
                                <option value="others">Others (å…¶ä»–)</option>
                            </select>
                        </div>
                        
                        <button type="submit" 
                            class="w-full bg-blue-500 text-white p-3 rounded hover:bg-blue-600 mb-2">
                            æ–°å¢æ”¯å‡º
                        </button>
                        <button type="button" onclick="changeView('menu')"
                            class="w-full bg-gray-300 text-gray-700 p-3 rounded hover:bg-gray-400">
                            è¿”å›
                        </button>
                    </form>
                </div>
            `;
            document.getElementById('app').innerHTML = html;

            // äº‹ä»¶ç›£è½
            document.getElementById('autoMode').addEventListener('change', function(e) {
                document.getElementById('category').style.display = e.target.checked ? 'none' : 'block';
            });

            document.getElementById('expenseForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const date = document.getElementById('expenseDate').value;
                const item = document.getElementById('item').value;
                const amount = parseFloat(document.getElementById('amount').value);
                const autoMode = document.getElementById('autoMode').checked;
                const category = autoMode ? autoCategory(item) : document.getElementById('category').value;
                
                expenses.push({ date, item, amount, category });
                alert(`âœ… æ”¯å‡ºç´€éŒ„å·²æ–°å¢ï¼ˆæ—¥æœŸç‚º ${date}ï¼Œåˆ†é¡ç‚º ${category}ï¼‰`);
                changeView('menu');
            });
        }

        // æ¸²æŸ“æ”¶æ”¯åˆ†æé é¢
        function renderChart() {
            if (monthlyIncome === null) {
                alert('âš  è«‹å…ˆè¨­å®šæ¯æœˆæ”¶å…¥');
                changeView('menu');
                return;
            }

            if (expenses.length === 0) {
                alert('âš  å°šç„¡ä»»ä½•æ”¯å‡ºè³‡æ–™');
                changeView('menu');
                return;
            }

            const totalExpense = expenses.reduce((sum, exp) => sum + exp.amount, 0);
            const balance = monthlyIncome - totalExpense;

            // æ”¯å‡ºæ˜ç´°è¡¨
            const expenseRows = expenses.map((exp, idx) => `
                <tr class="border-b">
                    <td class="p-2">${idx + 1}</td>
                    <td class="p-2">${exp.date}</td>
                    <td class="p-2">${exp.item}</td>
                    <td class="p-2">${exp.category}</td>
                    <td class="p-2 text-right">NT$ ${exp.amount.toFixed(2)}</td>
                </tr>
            `).join('');

            const html = `
                <div class="bg-white rounded-lg shadow-lg p-6 max-w-5xl mx-auto">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">ğŸ“Š æŸ¥çœ‹æ”¶æ”¯åˆ†æ</h2>
                    
                    <div class="mb-6 p-4 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg">
                        <h3 class="font-bold text-lg mb-2">ğŸ’° æ”¶æ”¯æ‘˜è¦</h3>
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div>
                                <p class="text-gray-600 text-sm">æ¯æœˆæ”¶å…¥</p>
                                <p class="text-xl font-bold text-green-600">NT$ ${monthlyIncome.toFixed(0)}</p>
                            </div>
                            <div>
                                <p class="text-gray-600 text-sm">ç¸½æ”¯å‡º</p>
                                <p class="text-xl font-bold text-red-600">NT$ ${totalExpense.toFixed(0)}</p>
                            </div>
                            <div>
                                <p class="text-gray-600 text-sm">å‰©é¤˜é‡‘é¡</p>
                                <p class="text-xl font-bold ${balance >= 0 ? 'text-blue-600' : 'text-red-600'}">
                                    NT$ ${balance.toFixed(0)}
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h3 class="font-bold text-lg mb-2">ğŸ“‹ æ”¯å‡ºæ˜ç´°è¡¨</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-2 text-left">#</th>
                                        <th class="p-2 text-left">æ—¥æœŸ</th>
                                        <th class="p-2 text-left">é …ç›®</th>
                                        <th class="p-2 text-left">åˆ†é¡</th>
                                        <th class="p-2 text-right">é‡‘é¡</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${expenseRows}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h3 class="font-bold text-lg mb-2">ğŸ“ˆ æ”¯å‡ºåˆ†å¸ƒåœ–</h3>
                        <canvas id="expenseChart" width="400" height="400"></canvas>
                    </div>
                    
                    <button onclick="changeView('menu')"
                        class="w-full bg-gray-300 text-gray-700 p-3 rounded hover:bg-gray-400">
                        è¿”å›ä¸»é¸å–®
                    </button>
                </div>
            `;
            document.getElementById('app').innerHTML = html;

            // ç¹ªè£½åœ–è¡¨
            const categoryData = {};
            expenses.forEach(exp => {
                categoryData[exp.category] = (categoryData[exp.category] || 0) + exp.amount;
            });

            const labels = Object.keys(categoryData);
            const data = Object.values(categoryData);
            const colors = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884D8'];

            const ctx = document.getElementById('expenseChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            
            chartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // æ¸²æŸ“ç›®æ¨™è¨­å®šé é¢
        function renderGoal() {
            const html = `
                <div class="bg-white rounded-lg shadow-lg p-6 max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">ğŸ¯ è¨­å®šç›®æ¨™ + æŠ•è³‡</h2>
                    
                    <div class="mb-6 flex gap-2">
                        <button id="tabGoal" onclick="switchTab('goal')" 
                            class="flex-1 p-2 rounded bg-purple-500 text-white">
                            ç›®æ¨™ + æŠ•è³‡è¨­å®š
                        </button>
                        <button id="tabStock" onclick="switchTab('stock')" 
                            class="flex-1 p-2 rounded bg-gray-200">
                            å€‹è‚¡æŸ¥è©¢
                        </button>
                    </div>

                    <div id="goalContent">
                        <input type="text" id="goalName" placeholder="ç†è²¡ç›®æ¨™ï¼ˆä¾‹å¦‚ï¼šæ—…éŠã€è²·é›»è…¦ï¼‰"
                            value="${goal || ''}"
                            class="w-full p-3 border rounded mb-3">
                        <input type="number" id="goalMoney" placeholder="ç›®æ¨™é‡‘é¡"
                            value="${goalAmount || ''}"
                            class="w-full p-3 border rounded mb-3">
                        
                        <div class="mb-4">
                            <label class="font-semibold text-gray-700 mb-2 block">é¸æ“‡æŠ•è³‡æ–¹å¼ï¼š</label>
                            <select id="investmentChoice" class="w-full p-3 border rounded">
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="1">å„²è“„ï¼ˆä½é¢¨éšªï¼‰- å¹´åŒ– 2%</option>
                                <option value="2">ETFï¼ˆä¸­é¢¨éšªï¼‰- å¹´åŒ– 5%</option>
                                <option value="3">è‚¡ç¥¨ï¼ˆé«˜é¢¨éšªï¼‰- å¹´åŒ– 8%</option>
                                <option value="4">åŠ å¯†è²¨å¹£ï¼ˆæ¥µé«˜é¢¨éšªï¼‰- å¹´åŒ– 12%</option>
                            </select>
                        </div>
                        
                        <button onclick="setGoalAndInvestment()"
                            class="w-full bg-purple-500 text-white p-3 rounded hover:bg-purple-600 mb-3">
                            ç¢ºèªè¨­å®š
                        </button>
                        
                        <div id="goalResult"></div>
                    </div>

                    <div id="stockContent" style="display: none;">
                        <div class="mb-2 text-sm text-gray-600">
                            æç¤ºï¼šç¾è‚¡è¼¸å…¥ä»£è™Ÿï¼ˆå¦‚ AAPLã€TSLAï¼‰ï¼Œå°è‚¡åŠ  .TWï¼ˆå¦‚ 2330.TWï¼‰
                        </div>
                        <input type="text" id="stockSymbol" placeholder="è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ (ä¾‹ï¼šAAPLã€TSLAã€2330.TW)"
                            class="w-full p-3 border rounded mb-3">
                        <button onclick="searchStock()"
                            class="w-full bg-blue-500 text-white p-3 rounded hover:bg-blue-600 mb-3">
                            ğŸ” æŸ¥è©¢å€‹è‚¡è³‡è¨Š
                        </button>
                        <div id="stockResult"></div>
                    </div>

                    <button onclick="changeView('menu')"
                        class="w-full mt-4 bg-gray-300 text-gray-700 p-3 rounded hover:bg-gray-400">
                        è¿”å›
                    </button>
                </div>
            `;
            document.getElementById('app').innerHTML = html;

            document.getElementById('stockSymbol').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchStock();
            });
        }

        // åˆ‡æ›ç›®æ¨™/è‚¡ç¥¨åˆ†é 
        function switchTab(tab) {
            if (tab === 'goal') {
                document.getElementById('tabGoal').className = 'flex-1 p-2 rounded bg-purple-500 text-white';
                document.getElementById('tabStock').className = 'flex-1 p-2 rounded bg-gray-200';
                document.getElementById('goalContent').style.display = 'block';
                document.getElementById('stockContent').style.display = 'none';
            } else {
                document.getElementById('tabGoal').className = 'flex-1 p-2 rounded bg-gray-200';
                document.getElementById('tabStock').className = 'flex-1 p-2 rounded bg-blue-500 text-white';
                document.getElementById('goalContent').style.display = 'none';
                document.getElementById('stockContent').style.display = 'block';
            }
        }

        // è¨­å®šç›®æ¨™èˆ‡æŠ•è³‡
        function setGoalAndInvestment() {
            goal = document.getElementById('goalName').value;
            goalAmount = parseFloat(document.getElementById('goalMoney').value);
            const choice = document.getElementById('investmentChoice').value;

            const mapping = {
                "1": ["å„²è“„", 0.02],
                "2": ["ETF", 0.05],
                "3": ["è‚¡ç¥¨", 0.08],
                "4": ["åŠ å¯†è²¨å¹£", 0.12]
            };

            if (!choice) {
                alert('è«‹é¸æ“‡æŠ•è³‡æ–¹å¼');
                return;
            }

            [investmentType, expectedReturn] = mapping[choice];

            document.getElementById('goalResult').innerHTML = `
                <div class="p-4 bg-purple-50 rounded border border-purple-200">
                    <h3 class="font-bold text-lg mb-2">ğŸ“ˆ AI æŠ•è³‡è©•ä¼°</h3>
                    <p class="mb-1">âœ… ç›®æ¨™å·²è¨­å®šï¼š<span class="font-semibold">${goal}</span></p>
                    <p class="mb-1">ğŸ’° ç›®æ¨™é‡‘é¡ï¼š<span class="font-semibold">NT$ ${goalAmount.toFixed(0)}</span></p>
                    <p class="mb-1">ğŸ“Š æŠ•è³‡æ–¹å¼ï¼š<span class="font-semibold">${investmentType}</span></p>
                    <p>ğŸ“ˆ é ä¼°å¹´åŒ–å ±é…¬ç‡ï¼š<span class="font-semibold text-green-600">${(expectedReturn * 100).toFixed(1)}%</span></p>
                </div>
            `;
        }

        // æŸ¥è©¢è‚¡ç¥¨
        async function searchStock() {
            const symbol = document.getElementById('stockSymbol').value.toUpperCase().trim();
            if (!symbol) {
                alert('è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ');
                return;
            }

            const resultDiv = document.getElementById('stockResult');
            resultDiv.innerHTML = '<p class="text-center">æŸ¥è©¢ä¸­...</p>';

            try {
                const corsProxy = 'https://api.allorigins.win/raw?url=';
                const apiUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=1y`;
                
                const response = await fetch(corsProxy + encodeURIComponent(apiUrl));
                if (!response.ok) throw new Error('ç„¡æ³•å–å¾—è‚¡ç¥¨è³‡æ–™');
                
                const data = await response.json();
                if (data.chart.error) throw new Error('æŸ¥ç„¡æ­¤è‚¡ç¥¨ä»£è™Ÿ');
                
                const quote = data.chart.result[0];
                const meta = quote.meta;
                const indicators = quote.indicators.quote[0];
                const closes = indicators.close;
                
                const high52w = Math.max(...indicators.high.filter(v => v !== null));
                const low52w = Math.min(...indicators.low.filter(v => v !== null));
                
                const currentPrice = meta.regularMarketPrice;
                const oneMonthAgo = closes[Math.max(0, closes.length - 22)] || closes[0];
                const monthlyChange = ((currentPrice - oneMonthAgo) / oneMonthAgo * 100).toFixed(2);
                
                const summaryUrl = `https://query1.finance.yahoo.com/v10/finance/quoteSummary/${symbol}?modules=defaultKeyStatistics,summaryDetail`;
                const summaryResponse = await fetch(corsProxy + encodeURIComponent(summaryUrl));
                const summaryData = await summaryResponse.json();
                
                const keyStats = summaryData?.quoteSummary?.result?.[0]?.defaultKeyStatistics || {};
                const summaryDetail = summaryData?.quoteSummary?.result?.[0]?.summaryDetail || {};
                
                const stockInfo = {
                    name: meta.longName || meta.shortName || symbol,
                    symbol: symbol,
                    price: currentPrice,
                    currency: meta.currency,
                    high52w: high52w,
                    low52w: low52w,
                    marketCap: meta.marketCap || summaryDetail.marketCap?.raw,
                    pe: keyStats.trailingPE?.raw || summaryDetail.trailingPE?.raw,
                    dividend: keyStats.dividendYield?.raw ? (keyStats.dividendYield.raw * 100).toFixed(2) : null,
                    monthlyChange: monthlyChange,
                    exchange: meta.exchangeName
                };

                const changeColor = parseFloat(stockInfo.monthlyChange) >= 0 ? 'text-green-600' : 'text-red-600';
                
                resultDiv.innerHTML = `
                    <div class="p-4 bg-gray-50 rounded border border-gray-200">
                        <h3 class="font-bold text-xl mb-4 text-gray-800">
                            ğŸ“Š ${stockInfo.name} (${stockInfo.symbol})
                        </h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between py-2 border-b">
                                <span class="font-semibold">ç›®å‰è‚¡åƒ¹ï¼š</span>
                                <span class="text-lg font-bold text-blue-600">
                                    ${stockInfo.currency} ${stockInfo.price.toFixed(2)}
                                </span>
                            </div>
                            <div class="flex justify-between py-2 border-b">
                                <span class="font-semibold">52 é€±æœ€é«˜åƒ¹ï¼š</span>
                                <span>${stockInfo.currency} ${stockInfo.high52w.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between py-2 border-b">
                                <span class="font-semibold">52 é€±æœ€ä½åƒ¹ï¼š</span>
                                <span>${stockInfo.currency} ${stockInfo.low52w.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between py-2 border-b">
                                <span class="font-semibold">å¸‚å€¼ï¼š</span>
                                <span>${formatNumber(stockInfo.marketCap)}</span>
                            </div>
                            <div class="flex justify-between py-2 border-b">
                                <span class="font-semibold">æœ¬ç›Šæ¯” (P/E)ï¼š</span>
                                <span>${stockInfo.pe ? stockInfo.pe.toFixed(2) : 'N/A'}</span>
                            </div>
                            <div class="flex justify-between py-2 border-b">
                                <span class="font-semibold">è‚¡æ¯æ®–åˆ©ç‡ï¼š</span>
                                <span>${stockInfo.dividend ? `${stockInfo.dividend}%` : 'N/A'}</span>
                            </div>
                            <div class="flex justify-between py-2">
                                <span class="font-semibold">è¿‘ 1 å€‹æœˆæ¼²è·Œï¼š</span>
                                <span class="font-bold ${changeColor}">
                                    ${stockInfo.monthlyChange}%
                                </span>
                            </div>
                            <div class="mt-3 text-xs text-gray-500 text-center">
                                äº¤æ˜“æ‰€ï¼š${stockInfo.exchange} | æ•¸æ“šä¾†æºï¼šYahoo Finance
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="p-4 bg-red-50 rounded border border-red-200">
                        <p class="text-red-600">æŸ¥è©¢å¤±æ•—ï¼š${error.message}ã€‚è«‹ç¢ºèªè‚¡ç¥¨ä»£è™Ÿæ˜¯å¦æ­£ç¢ºã€‚</p>
                    </div>
                `;
            }
        }

        // æ¸²æŸ“ç†è²¡å»ºè­°é é¢
        function renderAdvice() {
            if (monthlyIncome === null || expenses.length === 0) {
                alert('âš  è³‡æ–™ä¸è¶³ï¼Œç„¡æ³•é€²è¡Œ AI åˆ†æï¼ˆè«‹å…ˆè¨­å®šæ”¶å…¥ä¸¦æ–°å¢æ”¯å‡ºï¼‰');
                changeView('menu');
                return;
            }

            const totalExpense = expenses.reduce((sum, exp) => sum + exp.amount, 0);
            const stressIndex = (totalExpense / monthlyIncome * 100).toFixed(1);
            
            const categoryTotals = {};
            expenses.forEach(exp => {
                categoryTotals[exp.category] = (categoryTotals[exp.category] || 0) + exp.amount;
            });

            const topCategory = Object.keys(categoryTotals).reduce((a, b) => 
                categoryTotals[a] > categoryTotals[b] ? a : b
            );

            const suggestedSaving = monthlyIncome * 0.15;
            
            let stressLevel = '';
            let stressColor = '';
            if (stressIndex >= 70) {
                stressLevel = 'âš  è²¡å‹™å£“åŠ›åé«˜ï¼Œå»ºè­°èª¿æ•´éå¿…è¦æ”¯å‡º';
                stressColor = 'bg-red-50 border-red-200';
            } else if (stressIndex >= 50) {
                stressLevel = 'âš  è²¡å‹™ç‹€æ³å°šå¯ï¼Œä½†ä»æœ‰å„ªåŒ–ç©ºé–“';
                stressColor = 'bg-yellow-50 border-yellow-200';
            } else {
                stressLevel = 'âœ… è²¡å‹™ç‹€æ³å¥åº·';
                stressColor = 'bg-green-50 border-green-200';
            }

            let investmentAdvice = '';
            if (investmentType === 'å„²è“„') {
                investmentAdvice = 'âœ… ä¿å®ˆå‹ï¼šå¯æ¡ç”¨å®šå­˜æˆ–æ´»å­˜';
            } else if (investmentType === 'ETF') {
                investmentAdvice = 'âš– ç©©å¥å‹ï¼šå»ºè­°å®šæœŸå®šé¡ ETF';
            } else if (investmentType === 'è‚¡ç¥¨') {
                investmentAdvice = 'âš¡ ç©æ¥µå‹ï¼šåˆ†æ•£æŠ•è³‡è‚¡ç¥¨æˆ–ETF';
            } else if (investmentType === 'åŠ å¯†è²¨å¹£') {
                investmentAdvice = 'ğŸ”¥ é«˜é¢¨éšªå‹ï¼šåƒ…å»ºè­°å°‘é‡è³‡é‡‘æŠ•å…¥';
            }

            let goalAnalysis = '';
            if (goal && goalAmount && expectedReturn) {
                const investmentContrib = suggestedSaving;
                const monthsNeeded = goalAmount / (suggestedSaving + investmentContrib * (expectedReturn / 12));
                goalAnalysis = `
                    <div class="p-4 bg-blue-50 rounded border border-blue-200">
                        <p class="font-semibold mb-2">ğŸ¯ ç›®æ¨™åˆ†æï¼š</p>
                        <p class="text-sm">â€¢ ç›®æ¨™ã€Œ${goal}ã€é‡‘é¡ NT$ ${goalAmount.toFixed(0)}</p>
                        <p class="text-sm">â€¢ ä»¥æ¯æœˆå„²è“„ ${suggestedSaving.toFixed(0)} å…ƒ + æŠ•è³‡ ${investmentContrib.toFixed(0)} å…ƒ</p>
                        <p class="text-sm">â€¢ é è¨ˆå¯åœ¨ <span class="font-bold text-blue-600">${monthsNeeded.toFixed(1)}</span> å€‹æœˆé”æˆç›®æ¨™</p>
                    </div>
                `;
            }

            const html = `
                <div class="bg-white rounded-lg shadow-lg p-6 max-w-3xl mx-auto">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">ğŸ¤– AI å°ˆæ¥­ç†è²¡å»ºè­°å ±å‘Š</h2>
                    
                    <div class="space-y-4">
                        <div class="p-4 bg-purple-50 rounded border border-purple-200">
                            <p class="font-semibold mb-2">ğŸ“Œ ç•°å¸¸æ¶ˆè²»åˆ†æï¼š</p>
                            <p class="text-sm">â€¢ æ”¯å‡ºæœ€é«˜çš„é¡åˆ¥ç‚ºï¼š<span class="font-bold">${topCategory}</span></p>
                        </div>
                        
                        <div class="p-4 ${stressColor} rounded border">
                            <p class="font-semibold mb-2">ğŸ“Š è²¡å‹™å£“åŠ›æŒ‡æ•¸ï¼š</p>
                            <p class="text-sm">â€¢ å£“åŠ›æŒ‡æ•¸ï¼š<span class="font-bold">${stressIndex}%</span></p>
                            <p class="text-sm">â€¢ ${stressLevel}</p>
                        </div>
                        
                        ${investmentType ? `
                            <div class="p-4 bg-indigo-50 rounded border border-indigo-200">
                                <p class="font-semibold mb-2">ğŸ’¼ æŠ•è³‡é¢¨éšªå»ºè­°ï¼š</p>
                                <p class="text-sm">â€¢ ç›®å‰é¸æ“‡çš„æŠ•è³‡æ–¹å¼ï¼š<span class="font-bold">${investmentType}</span></p>
                                <p class="text-sm">â€¢ ${investmentAdvice}</p>
                            </div>
                        ` : ''}
                        
                        <div class="p-4 bg-green-50 rounded border border-green-200">
                            <p class="font-semibold mb-2">ğŸ’° è¡Œå‹•è¨ˆç•«å»ºè­°ï¼š</p>
                            <p class="text-sm">â€¢ å»ºè­°æ¯æœˆå„²è“„é‡‘é¡ï¼šç´„ <span class="font-bold">NT$ ${suggestedSaving.toFixed(0)}</span></p>
                        </div>
                        
                        ${goalAnalysis}
                    </div>
                    
                    <button onclick="changeView('menu')"
                        class="w-full mt-6 bg-gray-300 text-gray-700 p-3 rounded hover:bg-gray-400">
                        è¿”å›ä¸»é¸å–®
                    </button>
                </div>
            `;
            document.getElementById('app').innerHTML = html;
        }

        // æ¸²æŸ“å…±äº«å¸³æœ¬é é¢
        function renderShared() {
            const html = `
                <div class="bg-white rounded-lg shadow-lg p-6 max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">ğŸ‘¥ å…±äº«å¸³æœ¬çµç®—</h2>
                    
                    <form id="sharedForm" class="mb-6">
                        <input type="text" id="personName" placeholder="è«‹è¼¸å…¥å§“å" required
                            class="w-full p-3 border rounded mb-3">
                        <input type="number" id="personAmount" placeholder="è«‹è¼¸å…¥æ”¯ä»˜çš„é‡‘é¡" required
                            class="w-full p-3 border rounded mb-3" step="0.01">
                        
                        <button type="submit" 
                            class="w-full bg-pink-500 text-white p-3 rounded hover:bg-pink-600">
                            æ–°å¢è¨˜éŒ„
                        </button>
                    </form>

                    <div id="sharedResult"></div>
                    
                    <button onclick="changeView('menu')"
                        class="w-full mt-4 bg-gray-300 text-gray-700 p-3 rounded hover:bg-gray-400">
                        è¿”å›ä¸»é¸å–®
                    </button>
                </div>
            `;
            document.getElementById('app').innerHTML = html;

            document.getElementById('sharedForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('personName').value;
                const amount = parseFloat(document.getElementById('personAmount').value);
                
                sharedLedger.push({ name, amount });
                
                updateSharedResult();
                
                // æ¸…ç©ºè¡¨å–®
                document.getElementById('personName').value = '';
                document.getElementById('personAmount').value = '';
            });

            updateSharedResult();
        }

        // æ›´æ–°å…±äº«å¸³æœ¬çµæœ
        function updateSharedResult() {
            const resultDiv = document.getElementById('sharedResult');
            
            if (sharedLedger.length === 0) {
                resultDiv.innerHTML = '<p class="text-gray-500 text-center">å°šç„¡ä»»ä½•è¨˜éŒ„</p>';
                return;
            }

            const total = sharedLedger.reduce((sum, record) => sum + record.amount, 0);
            const avg = total / sharedLedger.length;

            const ledgerRows = sharedLedger.map((record, idx) => `
                <tr class="border-b">
                    <td class="p-2">${idx + 1}</td>
                    <td class="p-2">${record.name}</td>
                    <td class="p-2 text-right">NT$ ${record.amount.toFixed(2)}</td>
                </tr>
            `).join('');

            const settlementRows = sharedLedger.map(record => {
                const diff = record.amount - avg;
                let status = '';
                let statusColor = '';
                
                if (diff > 0) {
                    status = `æ‡‰æ”¶å› NT$ ${diff.toFixed(2)}`;
                    statusColor = 'text-green-600';
                } else if (diff < 0) {
                    status = `æ‡‰æ”¯ä»˜ NT$ ${(-diff).toFixed(2)}`;
                    statusColor = 'text-red-600';
                } else {
                    status = 'å·²çµæ¸…';
                    statusColor = 'text-gray-600';
                }
                
                return `
                    <tr class="border-b">
                        <td class="p-2">${record.name}</td>
                        <td class="p-2 text-right ${statusColor} font-semibold">${status}</td>
                    </tr>
                `;
            }).join('');

            resultDiv.innerHTML = `
                <div class="space-y-4">
                    <div class="p-4 bg-blue-50 rounded">
                        <h3 class="font-bold text-lg mb-2">ğŸ“Š å…±äº«å¸³æœ¬</h3>
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-2 text-left">#</th>
                                    <th class="p-2 text-left">å§“å</th>
                                    <th class="p-2 text-right">é‡‘é¡</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${ledgerRows}
                            </tbody>
                        </table>
                        <div class="mt-3 text-center">
                            <p class="text-sm text-gray-600">ç¸½é‡‘é¡ï¼š<span class="font-bold">NT$ ${total.toFixed(2)}</span></p>
                            <p class="text-sm text-gray-600">å¹³å‡æ¯äººï¼š<span class="font-bold">NT$ ${avg.toFixed(2)}</span></p>
                        </div>
                    </div>

                    <div class="p-4 bg-yellow-50 rounded">
                        <h3 class="font-bold text-lg mb-2">ğŸ’¸ çµç®—çµæœ</h3>
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-2 text-left">å§“å</th>
                                    <th class="p-2 text-right">ç‹€æ…‹</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${settlementRows}
                            </tbody>
                        </table>
                    </div>

                    <button onclick="clearSharedLedger()" 
                        class="w-full bg-red-500 text-white p-2 rounded hover:bg-red-600 text-sm">
                        æ¸…ç©ºæ‰€æœ‰è¨˜éŒ„
                    </button>
                </div>
            `;
        }

        // æ¸…ç©ºå…±äº«å¸³æœ¬
        function clearSharedLedger() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å…±äº«å¸³æœ¬è¨˜éŒ„å—ï¼Ÿ')) {
                sharedLedger = [];
                updateSharedResult();
            }
        }

        // åˆ‡æ›é é¢
        function changeView(view) {
            activeView = view;
            switch(view) {
                case 'menu':
                    renderMenu();
                    break;
                case 'income':
                    renderIncome();
                    break;
                case 'add':
                    renderAddExpense();
                    break;
                case 'chart':
                    renderChart();
                    break;
                case 'goal':
                    renderGoal();
                    break;
                case 'advice':
                    renderAdvice();
                    break;
                case 'shared':
                    renderShared();
                    break;
            }
        }

        // åˆå§‹åŒ–
        renderMenu();
    </script>
</body>
</html>
