<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanceAI æ™ºæ…§ç†è²¡ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
    <div id="app"></div>

    <script>
        // å…¨åŸŸç‹€æ…‹
        let expenses = [];
        let activeView = 'menu';
        let chartInstance = null;

        // è‡ªå‹•åˆ†é¡åŠŸèƒ½
        function autoCategory(item) {
            const itemLower = item.toLowerCase();
            const mapping = {
                food: ["food", "meal", "drink", "é£²æ–™", "é¤", "åƒ"],
                transport: ["bus", "train", "uber", "transport", "è»Š", "æ·é‹"],
                entertainment: ["game", "movie", "fun", "å¨›æ¨‚"],
                study: ["book", "study", "è£œç¿’", "å­¸ç¿’"]
            };
            
            for (const [category, keywords] of Object.entries(mapping)) {
                if (keywords.some(k => itemLower.includes(k))) {
                    return category;
                }
            }
            return "others";
        }

        // æ ¼å¼åŒ–æ•¸å­—
        function formatNumber(num) {
            if (!num) return 'N/A';
            if (num >= 1e12) return `$${(num / 1e12).toFixed(2)}T`;
            if (num >= 1e9) return `$${(num / 1e9).toFixed(2)}B`;
            if (num >= 1e6) return `$${(num / 1e6).toFixed(2)}M`;
            return `$${num.toFixed(2)}`;
        }

        // æ¸²æŸ“ä¸»é¸å–®
        function renderMenu() {
            const menuItems = [
                { icon: 'â•', label: 'æ–°å¢è¨˜å¸³', view: 'add', color: 'bg-blue-500' },
                { icon: 'ğŸ“Š', label: 'æŸ¥çœ‹æ”¶æ”¯åˆ†æ', view: 'chart', color: 'bg-green-500' },
                { icon: 'ğŸ¯', label: 'è¨­å®šç›®æ¨™ + æŠ•è³‡', view: 'goal', color: 'bg-purple-500' },
                { icon: 'ğŸ’¡', label: 'å°ˆæ¥­ç†è²¡å»ºè­°', view: 'advice', color: 'bg-yellow-500' }
            ];

            const menuHTML = `
                <div class="max-w-4xl mx-auto">
                    <div class="text-center mb-8">
                        <h1 class="text-4xl font-bold text-gray-800 mb-2">FinanceAI</h1>
                        <p class="text-gray-600">æ™ºæ…§ç†è²¡ç®¡ç†ç³»çµ±</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${menuItems.map(item => `
                            <button onclick="changeView('${item.view}')" 
                                class="${item.color} text-white p-6 rounded-lg shadow-lg hover:opacity-90 transition-all transform hover:scale-105">
                                <div class="text-5xl mb-3">${item.icon}</div>
                                <p class="text-xl font-semibold">${item.label}</p>
                            </button>
                        `).join('')}
                    </div>
                    
                    ${expenses.length > 0 ? `
                        <div class="mt-6 p-4 bg-white rounded-lg shadow">
                            <p class="text-center text-gray-700">
                                ğŸ“Š ç›®å‰å…±æœ‰ <span class="font-bold">${expenses.length}</span> ç­†è¨˜å¸³è³‡æ–™
                            </p>
                        </div>
                    ` : ''}
                </div>
            `;
            document.getElementById('app').innerHTML = menuHTML;
        }

        // æ¸²æŸ“æ–°å¢è¨˜å¸³é é¢
        function renderAddExpense() {
            const html = `
                <div class="bg-white rounded-lg shadow-lg p-6 max-w-md mx-auto">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">æ–°å¢è¨˜å¸³</h2>
                    <form id="expenseForm">
                        <input type="text" id="item" placeholder="é …ç›®åç¨±" required
                            class="w-full p-3 border rounded mb-3">
                        <input type="number" id="amount" placeholder="é‡‘é¡" required
                            class="w-full p-3 border rounded mb-3" step="0.01">
                        
                        <div class="mb-4">
                            <label class="flex items-center mb-2">
                                <input type="checkbox" id="autoMode" checked class="mr-2">
                                <span>è‡ªå‹•åˆ†é¡</span>
                            </label>
                            
                            <select id="category" class="w-full p-3 border rounded" style="display: none;">
                                <option value="">é¸æ“‡åˆ†é¡</option>
                                <option value="food">Food</option>
                                <option value="transport">Transport</option>
                                <option value="entertainment">Entertainment</option>
                                <option value="study">Study</option>
                                <option value="others">Others</option>
                            </select>
                        </div>
                        
                        <button type="submit" 
                            class="w-full bg-blue-500 text-white p-3 rounded hover:bg-blue-600 mb-2">
                            æ–°å¢
                        </button>
                        <button type="button" onclick="changeView('menu')"
                            class="w-full bg-gray-300 text-gray-700 p-3 rounded hover:bg-gray-400">
                            è¿”å›
                        </button>
                    </form>
                </div>
            `;
            document.getElementById('app').innerHTML = html;

            // äº‹ä»¶ç›£è½
            document.getElementById('autoMode').addEventListener('change', function(e) {
                document.getElementById('category').style.display = e.target.checked ? 'none' : 'block';
            });

            document.getElementById('expenseForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const item = document.getElementById('item').value;
                const amount = parseFloat(document.getElementById('amount').value);
                const autoMode = document.getElementById('autoMode').checked;
                const category = autoMode ? autoCategory(item) : document.getElementById('category').value;
                
                expenses.push({ item, amount, category });
                alert('âœ” å·²æ–°å¢ï¼');
                changeView('menu');
            });
        }

        // æ¸²æŸ“æ”¶æ”¯åˆ†æé é¢
        function renderChart() {
            const html = `
                <div class="bg-white rounded-lg shadow-lg p-6 max-w-3xl mx-auto">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">æ”¶æ”¯åˆ†æ</h2>
                    ${expenses.length > 0 ? 
                        '<canvas id="expenseChart" width="400" height="400"></canvas>' : 
                        '<p class="text-center text-gray-500">ç›®å‰æ²’æœ‰è³‡æ–™</p>'
                    }
                    <button onclick="changeView('menu')"
                        class="w-full mt-4 bg-gray-300 text-gray-700 p-3 rounded hover:bg-gray-400">
                        è¿”å›
                    </button>
                </div>
            `;
            document.getElementById('app').innerHTML = html;

            if (expenses.length > 0) {
                const categoryData = {};
                expenses.forEach(exp => {
                    categoryData[exp.category] = (categoryData[exp.category] || 0) + exp.amount;
                });

                const labels = Object.keys(categoryData);
                const data = Object.values(categoryData);
                const colors = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884D8'];

                const ctx = document.getElementById('expenseChart').getContext('2d');
                if (chartInstance) chartInstance.destroy();
                
                chartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }

        // æ¸²æŸ“ç›®æ¨™è¨­å®šé é¢
        function renderGoal() {
            const html = `
                <div class="bg-white rounded-lg shadow-lg p-6 max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">è¨­å®šç›®æ¨™ + æŠ•è³‡</h2>
                    
                    <div class="mb-6 flex gap-2">
                        <button id="tabGoal" onclick="switchTab('goal')" 
                            class="flex-1 p-2 rounded bg-green-500 text-white">
                            ç›®æ¨™è¨ˆç®—
                        </button>
                        <button id="tabStock" onclick="switchTab('stock')" 
                            class="flex-1 p-2 rounded bg-gray-200">
                            å€‹è‚¡æŸ¥è©¢
                        </button>
                    </div>

                    <div id="goalContent">
                        <input type="text" id="goalName" placeholder="ç›®æ¨™åç¨± (ä¾‹ï¼šå‡ºåœ‹ã€è²·é›»è…¦)"
                            class="w-full p-3 border rounded mb-3">
                        <input type="number" id="goalMoney" placeholder="ç›®æ¨™é‡‘é¡"
                            class="w-full p-3 border rounded mb-3">
                        <input type="number" id="monthlySave" placeholder="æ¯æœˆå¯å„²è“„"
                            class="w-full p-3 border rounded mb-3">
                        
                        <label class="flex items-center mb-3">
                            <input type="checkbox" id="useInvestment" class="mr-2">
                            <span>åŠ å…¥æŠ•è³‡æ”¶ç›Š</span>
                        </label>
                        
                        <div id="investmentRate" style="display: none;">
                            <input type="number" id="rate" placeholder="é æœŸå¹´åŒ–å ±é…¬ç‡ (%)"
                                class="w-full p-3 border rounded mb-3" step="0.1">
                        </div>
                        
                        <button onclick="calculateGoal()"
                            class="w-full bg-green-500 text-white p-3 rounded hover:bg-green-600 mb-3">
                            è¨ˆç®—
                        </button>
                        
                        <div id="goalResult"></div>
                    </div>

                    <div id="stockContent" style="display: none;">
                        <div class="mb-2 text-sm text-gray-600">
                            æç¤ºï¼šç¾è‚¡è¼¸å…¥ä»£è™Ÿï¼ˆå¦‚ AAPLã€TSLAï¼‰ï¼Œå°è‚¡åŠ  .TWï¼ˆå¦‚ 2330.TWï¼‰
                        </div>
                        <input type="text" id="stockSymbol" placeholder="è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ (ä¾‹ï¼šAAPLã€TSLAã€2330.TW)"
                            class="w-full p-3 border rounded mb-3">
                        <button onclick="searchStock()"
                            class="w-full bg-blue-500 text-white p-3 rounded hover:bg-blue-600 mb-3">
                            ğŸ” æŸ¥è©¢å€‹è‚¡è³‡è¨Š
                        </button>
                        <div id="stockResult"></div>
                    </div>

                    <button onclick="changeView('menu')"
                        class="w-full mt-4 bg-gray-300 text-gray-700 p-3 rounded hover:bg-gray-400">
                        è¿”å›
                    </button>
                </div>
            `;
            document.getElementById('app').innerHTML = html;

            // äº‹ä»¶ç›£è½
            document.getElementById('useInvestment').addEventListener('change', function(e) {
                document.getElementById('investmentRate').style.display = e.target.checked ? 'block' : 'none';
            });

            document.getElementById('stockSymbol').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchStock();
            });
        }

        // åˆ‡æ›ç›®æ¨™/è‚¡ç¥¨åˆ†é 
        function switchTab(tab) {
            if (tab === 'goal') {
                document.getElementById('tabGoal').className = 'flex-1 p-2 rounded bg-green-500 text-white';
                document.getElementById('tabStock').className = 'flex-1 p-2 rounded bg-gray-200';
                document.getElementById('goalContent').style.display = 'block';
                document.getElementById('stockContent').style.display = 'none';
            } else {
                document.getElementById('tabGoal').className = 'flex-1 p-2 rounded bg-gray-200';
                document.getElementById('tabStock').className = 'flex-1 p-2 rounded bg-blue-500 text-white';
                document.getElementById('goalContent').style.display = 'none';
                document.getElementById('stockContent').style.display = 'block';
            }
        }

        // è¨ˆç®—ç›®æ¨™
        function calculateGoal() {
            const goalName = document.getElementById('goalName').value;
            const goalMoney = parseFloat(document.getElementById('goalMoney').value);
            const monthlySave = parseFloat(document.getElementById('monthlySave').value);
            const useInvestment = document.getElementById('useInvestment').checked;
            
            let months;
            if (useInvestment) {
                const rate = parseFloat(document.getElementById('rate').value) / 100;
                months = Math.log(1 + (goalMoney * rate) / (12 * monthlySave)) / Math.log(1 + rate / 12);
            } else {
                months = goalMoney / monthlySave;
            }
            
            document.getElementById('goalResult').innerHTML = `
                <div class="p-4 bg-blue-50 rounded">
                    <p class="text-lg font-semibold text-blue-800">
                        ğŸ“Œ é”æˆã€Œ${goalName}ã€éœ€è¦å¤§ç´„ï¼š${months.toFixed(1)} å€‹æœˆ
                    </p>
                </div>
            `;
        }

        // æŸ¥è©¢è‚¡ç¥¨
        async function searchStock() {
            const symbol = document.getElementById('stockSymbol').value.toUpperCase().trim();
            if (!symbol) {
                alert('è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ');
                return;
            }

            const resultDiv = document.getElementById('stockResult');
            resultDiv.innerHTML = '<p class="text-center">æŸ¥è©¢ä¸­...</p>';

            try {
                const corsProxy = 'https://api.allorigins.win/raw?url=';
                const apiUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=1y`;
                
                const response = await fetch(corsProxy + encodeURIComponent(apiUrl));
                if (!response.ok) throw new Error('ç„¡æ³•å–å¾—è‚¡ç¥¨è³‡æ–™');
                
                const data = await response.json();
                if (data.chart.error) throw new Error('æŸ¥ç„¡æ­¤è‚¡ç¥¨ä»£è™Ÿ');
                
                const quote = data.chart.result[0];
                const meta = quote.meta;
                const indicators = quote.indicators.quote[0];
                const closes = indicators.close;
                
                const high52w = Math.max(...indicators.high.filter(v => v !== null));
                const low52w = Math.min(...indicators.low.filter(v => v !== null));
                
                const currentPrice = meta.regularMarketPrice;
                const oneMonthAgo = closes[Math.max(0, closes.length - 22)] || closes[0];
                const monthlyChange = ((currentPrice - oneMonthAgo) / oneMonthAgo * 100).toFixed(2);
                
                const summaryUrl = `https://query1.finance.yahoo.com/v10/finance/quoteSummary/${symbol}?modules=defaultKeyStatistics,summaryDetail`;
                const summaryResponse = await fetch(corsProxy + encodeURIComponent(summaryUrl));
                const summaryData = await summaryResponse.json();
                
                const keyStats = summaryData?.quoteSummary?.result?.[0]?.defaultKeyStatistics || {};
                const summaryDetail = summaryData?.quoteSummary?.result?.[0]?.summaryDetail || {};
                
                const stockInfo = {
                    name: meta.longName || meta.shortName || symbol,
                    symbol: symbol,
                    price: currentPrice,
                    currency: meta.currency,
                    high52w: high52w,
                    low52w: low52w,
                    marketCap: meta.marketCap || summaryDetail.marketCap?.raw,
                    pe: keyStats.trailingPE?.raw || summaryDetail.trailingPE?.raw,
                    dividend: keyStats.dividendYield?.raw ? (keyStats.dividendYield.raw * 100).toFixed(2) : null,
                    monthlyChange: monthlyChange,
                    exchange: meta.exchangeName
                };

                const changeColor = parseFloat(stockInfo.monthlyChange) >= 0 ? 'text-green-600' : 'text-red-600';
                
                resultDiv.innerHTML = `
                    <div class="p-4 bg-gray-50 rounded border border-gray-200">
                        <h3 class="font-bold text-xl mb-4 text-gray-800">
                            ğŸ“Š ${stockInfo.name} (${stockInfo.symbol})
                        </h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between py-2 border-b">
                                <span class="font-semibold">ç›®å‰è‚¡åƒ¹ï¼š</span>
                                <span class="text-lg font-bold text-blue-600">
                                    ${stockInfo.currency} ${stockInfo.price.toFixed(2)}
                                </span>
                            </div>
                            <div class="flex justify-between py-2 border-b">
                                <span class="font-semibold">52 é€±æœ€é«˜åƒ¹ï¼š</span>
                                <span>${stockInfo.currency} ${stockInfo.high52w.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between py-2 border-b">
                                <span class="font-semibold">52 é€±æœ€ä½åƒ¹ï¼š</span>
                                <span>${stockInfo.currency} ${stockInfo.low52w.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between py-2 border-b">
                                <span class="font-semibold">å¸‚å€¼ï¼š</span>
                                <span>${formatNumber(stockInfo.marketCap)}</span>
                            </div>
                            <div class="flex justify-between py-2 border-b">
                                <span class="font-semibold">æœ¬ç›Šæ¯” (P/E)ï¼š</span>
                                <span>${stockInfo.pe ? stockInfo.pe.toFixed(2) : 'N/A'}</span>
                            </div>
                            <div class="flex justify-between py-2 border-b">
                                <span class="font-semibold">è‚¡æ¯æ®–åˆ©ç‡ï¼š</span>
                                <span>${stockInfo.dividend ? `${stockInfo.dividend}%` : 'N/A'}</span>
                            </div>
                            <div class="flex justify-between py-2">
                                <span class="font-semibold">è¿‘ 1 å€‹æœˆæ¼²è·Œï¼š</span>
                                <span class="font-bold ${changeColor}">
                                    ${stockInfo.monthlyChange}%
                                </span>
                            </div>
                            <div class="mt-3 text-xs text-gray-500 text-center">
                                äº¤æ˜“æ‰€ï¼š${stockInfo.exchange} | æ•¸æ“šä¾†æºï¼šYahoo Finance
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="p-4 bg-red-50 rounded border border-red-200">
                        <p class="text-red-600">æŸ¥è©¢å¤±æ•—ï¼š${error.message}ã€‚è«‹ç¢ºèªè‚¡ç¥¨ä»£è™Ÿæ˜¯å¦æ­£ç¢ºã€‚</p>
                    </div>
                `;
            }
        }

        // æ¸²æŸ“ç†è²¡å»ºè­°é é¢
        function renderAdvice() {
            const total = expenses.reduce((sum, exp) => sum + exp.amount, 0);
            const categoryTotals = {};
            expenses.forEach(exp => {
                categoryTotals[exp.category] = (categoryTotals[exp.category] || 0) + exp.amount;
            });

            const maxCategory = Object.keys(categoryTotals).reduce((a, b) => 
                categoryTotals[a] > categoryTotals[b] ? a : b, 'food'
            );
            const foodRatio = (categoryTotals[maxCategory] || 0) / total;
            const score = Math.round((1 - foodRatio) * 100);

            const html = `
                <div class="bg-white rounded-lg shadow-lg p-6 max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">ğŸ¤– AI ç†è²¡å»ºè­°ï¼ˆå°ˆæ¥­ç‰ˆï¼‰</h2>
                    
                    ${expenses.length === 0 ? 
                        '<p class="text-gray-500">æ²’æœ‰è³‡æ–™ç„¡æ³•åˆ†æ</p>' :
                        `<div class="space-y-4">
                            <div class="p-4 bg-yellow-50 rounded">
                                <p class="font-semibold">ğŸ“Œ è²¡å‹™å£“åŠ›åˆ†æ•¸ï¼š${score}/100</p>
                            </div>
                            
                            ${foodRatio > 0.45 ? `
                                <div class="p-4 bg-red-50 rounded">
                                    <p class="font-semibold">ğŸ“Œ ä½ çš„é£Ÿç‰©æ”¯å‡ºé é«˜æ–¼å¤§å­¸ç”Ÿå¹³å‡ï¼ˆ40%ï¼‰</p>
                                </div>
                            ` : ''}
                            
                            <div class="p-4 bg-blue-50 rounded">
                                <p class="font-semibold">ğŸ“Œ å»ºè­°æŠ•è³‡çµ„åˆï¼š</p>
                                <p class="text-sm mt-1">ETF 60% + é«˜è‚¡æ¯ 20% + å‚µåˆ¸ 20%</p>
                            </div>
                            
                            <div class="p-4 bg-green-50 rounded">
                                <p class="font-semibold">ğŸ“Œ å»ºè­°å°‡æ¯æœˆå„²è“„ç‡æå‡è‡³ 15%</p>
                            </div>
                            
                            <div class="p-4 bg-purple-50 rounded">
                                <p class="font-semibold">ğŸ“Œ è¡Œå‹•å»ºè­°ï¼š</p>
                                <p class="text-sm mt-1">æœ¬æœˆæ¸›å°‘å¤–é£Ÿ 10%ï¼Œå¯æå‡å„²è“„ç‡ 4%</p>
                            </div>
                        </div>`
                    }
                    
                    <button onclick="changeView('menu')"
                        class="w-full mt-4 bg-gray-300 text-gray-700 p-3 rounded hover:bg-gray-400">
                        è¿”å›
                    </button>
                </div>
            `;
            document.getElementById('app').innerHTML = html;
        }

        // åˆ‡æ›é é¢
        function changeView(view) {
            activeView = view;
            switch(view) {
                case 'menu':
                    renderMenu();
                    break;
                case 'add':
                    renderAddExpense();
                    break;
                case 'chart':
                    renderChart();
                    break;
                case 'goal':
                    renderGoal();
                    break;
                case 'advice':
                    renderAdvice();
                    break;
            }
        }

        // åˆå§‹åŒ–
        renderMenu();
    </script>
</body>
</html>